package application;

import java.io.BufferedReader;
import java.io.File;
import java.io.FileReader;
import java.io.IOException;

import org.jsoup.Jsoup;
import org.jsoup.nodes.Comment;
import org.jsoup.nodes.Document;
import org.jsoup.nodes.Element;
import org.jsoup.nodes.Node;
import org.jsoup.select.Elements;

import javafx.stage.FileChooser;

public class OpenTest
{
	/**
	 * <b>fromFile</b><br>
	 * <br>
	 * Opens the FileDialog and asks a user to select an HTML file.<br>
	 * If a file is chosen, then loadValuesIntoTestStepPane(fileName) is called.
	 */
	public static void fromFile()
	{
		// Prompt User to select file
		// https://docs.oracle.com/javase/8/javafx/api/javafx/stage/FileChooser.html
		FileChooser fileChooser = new FileChooser();
        fileChooser.setTitle("Open Test Case");
        //Extension filter
        FileChooser.ExtensionFilter extentionFilter = new FileChooser.ExtensionFilter("HTML (*.html)", "*.html");
        fileChooser.getExtensionFilters().add(extentionFilter);
		File fileName = fileChooser.showOpenDialog(null);
		if (fileName != null)
		{
			TestStepsPane.testStepsVbox.getChildren().clear();
			loadValuesIntoTestStepPane(fileName.toString());
		}
	}
	
	/**
	 * <b>loadValuesIntoTestStepPane</b><br>
	 * <br>
	 * Imports the test steps from a given file into the application.<br>
	 * @param fileName
	 */
	private static void loadValuesIntoTestStepPane(String fileName)
	{
		String baseAddress = "";
		String description = "";
		String action = "";
		
		String target = "";
		String value = "";
		
		// Read the html file and convert to a String
		StringBuilder contentBuilder = new StringBuilder();
		try
		{
		    BufferedReader in = new BufferedReader(new FileReader(fileName));
		    String str;
		    while ((str = in.readLine()) != null)
		    {
		        contentBuilder.append(str);
		    }
		    in.close();
		}
		catch (IOException e)
		{
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
		String content = contentBuilder.toString();
		
		// Get the Base Address
		baseAddress = content.substring( content.indexOf("<link")+32, content.lastIndexOf(" />")-1 );
		
		// Set the Base Address
		TestStepsPane.baseAddresstextField.setText(baseAddress);
		
		// Get the table of test steps
		Document doc = Jsoup.parse(content);
		Element table = doc.select("table").first();

		// Get the rows in the table
		Elements rows = table.select("tr");
		for (Element row : rows)
		{
			// Get the previous node/element; the one before this table row
			Node previousSiblingNode = row.previousSibling();
			// Assure that the previous node...
			if 	(
				( previousSiblingNode != null ) && // is not null
				( row.previousSibling().getClass().getName() == "org.jsoup.nodes.Comment" ) && // is a Comment
				( ((Comment) previousSiblingNode).getData().length() > 0 ) // has some value
				)
			{
				description = ((Comment)previousSiblingNode).getData();
				
				for (int i = 0; i < row.childNodes().size(); i++)
				{
					Node childNode = row.childNodes().get(i);
					
					if (i == 1) { action = ((Element) childNode).text(); }
					else if (i==3) { target = ((Element) childNode).text(); }
					else if (i==5) { value = ((Element) childNode).text(); }
				}
				
				// Finally Add the test step to the Test Steps Pane
				StepBuilderPane.description.setText(description);
				StepBuilderPane.command.setValue(action);
				StepBuilderPane.target.setText(target);
				StepBuilderPane.value.setText(value);
				StepBuilderPane.addTestSteps();
			}
		}
	}
}